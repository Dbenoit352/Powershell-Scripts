# Check for Administrator privileges
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Warning "Please run this script as an Administrator!"
    Break
}

# Enable Ultimate Performance power plan
Write-Output "Enabling Ultimate Performance power plan..."
$UltimatePlanGuid = "e9a42b02-d5df-448d-aa00-03f14749eb61"

# Check if the Ultimate Performance plan exists
$ExistingPlan = powercfg -list | Select-String -Pattern $UltimatePlanGuid
if (-not $ExistingPlan) {
    powercfg -duplicatescheme $UltimatePlanGuid
    Write-Output "Ultimate Performance plan added."
} else {
    Write-Output "Ultimate Performance plan already exists."
}

# Retrieve the GUID dynamically if necessary
if (-not $ExistingPlan -and $ExistingPlan -match "GUID: (.*)") {
    $UltimatePlanGuid = $matches[1].Trim()
} else {
    $Schemes = powercfg -list
    if ($Schemes -match "Power Scheme GUID: (.*) \(Ultimate Performance\)") {
        $UltimatePlanGuid = $matches[1].Trim()
    }
}

# Set the Ultimate Performance plan as active
Write-Output "Switching to Ultimate Performance plan..."
powercfg -setactive $UltimatePlanGuid

# Disable all sleep options in power settings
Write-Output "Disabling all sleep options..."
# Disable monitor timeout when plugged in and on battery
powercfg -change monitor-timeout-ac 0
powercfg -change monitor-timeout-dc 0

# Disable disk timeout when plugged in and on battery
powercfg -change disk-timeout-ac 0
powercfg -change disk-timeout-dc 0

# Disable sleep when plugged in and on battery
powercfg -change -standby-timeout-ac 0
powercfg -change -standby-timeout-dc 0

# Disable hibernate when plugged in and on battery
powercfg -change -hibernate-timeout-ac 0
powercfg -change -hibernate-timeout-dc 0

# Disable hybrid sleep
powercfg -setacvalueindex $UltimatePlanGuid 238c9fa8-0aad-41ed-83f4-97be242c8f20 94ac6d29-73ce-41a6-809f-6363ba21b47e 0
powercfg -setdcvalueindex $UltimatePlanGuid 238c9fa8-0aad-41ed-83f4-97be242c8f20 94ac6d29-73ce-41a6-809f-6363ba21b47e 0
powercfg -setacvalueindex $UltimatePlanGuid 4f971e89-eebd-4455-a8de-9e59040e7347 96996bc0-ad50-47ec-923b-6f41874dd9eb 0
powercfg -setdcvalueindex $UltimatePlanGuid 4f971e89-eebd-4455-a8de-9e59040e7347 96996bc0-ad50-47ec-923b-6f41874dd9eb 0

Write-Output "Ultimate Performance plan is now active, and sleep options are disabled."
